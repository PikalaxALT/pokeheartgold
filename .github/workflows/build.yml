name: build

on:
  push:
    branches: [ master ]
  pull_request:
  workflow_dispatch:

env:
  LM_LICENSE_FILE: "$GITHUB_WORKSPACE/tools/mwccarm/license.dat"
  CC: gcc-10
  CXX: g++-10
  CALCROM_DISCORD_WEBHOOK_AVATAR_URL: "https://i.imgur.com/38BQHdd.png"
  CALCROM_DISCORD_WEBHOOK_USERNAME: OK
  CALCROM_WEBHOOK_URL: ${{ secrets.WEBHOOKURL }}
  COMPARE: 1

jobs:
  build-docker-image:
    runs-on: ubuntu-latest
    outputs:
      imageid: steps.get-changed-files.outputs.test_any_changed == 'true' && steps.build-docker.outputs.imageid || "pret/pokeheartgold:latest"
    steps:
      -
        name: Checkout
        uses: actions/checkout@v4
      -
        name: Get build tag
        id: build-tag
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            echo 'docker-tag=latest' >> "$GITHUB_OUTPUT"
          else
            echo "docker-tag=${{ github.run_number }}-$(echo ${{ github.sha }} | head -c8)" >> "$GITHUB_OUTPUT"
          fi
      -
        name: Check if Dockerfile was changed
        id: get-changed-files
        uses: tj-actions/changed-files@v46
        with:
          files: Dockerfile
      - uses: docker/login-action@v3
        if: steps.changed-files-yaml.outputs.test_any_changed == 'true'
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      -
        name: Set up QEMU
        if: steps.changed-files-yaml.outputs.test_any_changed == 'true'
        uses: docker/setup-qemu-action@v3
      -
        name: Set up Docker Buildx
        if: steps.changed-files-yaml.outputs.test_any_changed == 'true'
        uses: docker/setup-buildx-action@v3
      -
        name: Build Docker image
        id: build-docker
        if: steps.changed-files-yaml.outputs.test_any_changed == 'true'
        uses: docker/build-and-push@v6
        with:
          push: github.event_name == 'push'
          tags: ${{github.repository}}:${{steps.build-tag.outputs.docker-tag}}

  build:
    runs-on: ubuntu-22.04
    needs: [build-docker-image]
    container: needs.build-docker-image.outputs.imageid

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup Repo
        run: |
          mkdir -p ~/download
          cd ~/download
          wget https://github.com/pret/pokeheartgold/raw/workflows/assets/mwccarm.zip
          wget https://github.com/pret/pokeheartgold/raw/workflows/assets/NitroSDK-3_2-060901.7z
          unzip mwccarm.zip
          mv mwccarm $GITHUB_WORKSPACE/tools
          7z x NitroSDK-3_2-060901.7z
          mv NitroSDK-3_2-060901/tools/bin $GITHUB_WORKSPACE/tools
          mv NitroSDK-3_2-060901/include/nitro/specfiles/ARM7-TS.lcf.template $GITHUB_WORKSPACE/sub/
          mv NitroSDK-3_2-060901/include/nitro/specfiles/ARM9-TS.lcf.template $GITHUB_WORKSPACE/
          mv NitroSDK-3_2-060901/include/nitro/specfiles/mwldarm.response.template $GITHUB_WORKSPACE/
        working-directory: "~"

      - name: Set Swap Space
        uses: pierotofy/set-swap-space@master
        with:
          swap-size-gb: 19

      - name: Build HeartGold
        env:
          GAME_VERSION: HEARTGOLD
          GAME_LANGUAGE: ENGLISH
          GAME_REVISION: 0
        run: make -j4

      - name: Build SoulSilver
        env:
          GAME_VERSION: SOULSILVER
          GAME_LANGUAGE: ENGLISH
          GAME_REVISION: 0
        run: make -j4

      - name: Webhook
        if: ${{ github.event_name == 'push' }}
        run: |
          sudo chmod 755 $GITHUB_WORKSPACE/.github/calcrom/webhook.sh
          $GITHUB_WORKSPACE/.github/calcrom/webhook.sh pokeheartgold "$CALCROM_WEBHOOK_URL"
        continue-on-error: true

      - name: Post error archive
        if: failure()
        continue-on-error: true
        run: find . -maxdepth 2 -type d \( -name build -or -name files \) -exec tar -czvhf failure.tar.gz {} +

      - name: Post error upload
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: pokeheartgold-failure-${{ github.run_id }}
          path: failure.tar.gz
          retention-days: 1

      - name: Checkout xMAP
        if: ${{ github.event_name == 'push' }}
        uses: actions/checkout@v4
        with:
          path: 'xmap'
          ref: 'xmap'

      - name: Move xMAP
        if: ${{ github.event_name == 'push' }}
        run: |
          mkdir -p xmap
          cp build/heartgold.us/*.xMAP xmap/heartgoldus.xMAP
          cp build/soulsilver.us/*.xMAP xmap/soulsilverus.xMAP
          echo "XMAP_COMMIT_MSG=$( git log --format=%s ${GITHUB_SHA} )" >> $GITHUB_ENV

      - name: Update xMAP
        if: ${{ github.event_name == 'push' }}
        uses: EndBug/add-and-commit@v9
        with:
          cwd: "./xmap"
          add: "*.xMAP"
          message: ${{ env.XMAP_COMMIT_MSG }}
